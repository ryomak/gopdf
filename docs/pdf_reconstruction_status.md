# PDF再構成の現状と課題

## 調査日
2025-10-29

## 実装済みの修正

### 1. ✅ 日本語テキスト抽出（完了）
**問題:** TTFフォントでのテキスト抽出が文字化けしていた
**修正:** グリフベースのToUnicode CMを実装
**コミット:** 583dd4d

### 2. ✅ Y座標系の動作（検証完了）
**確認結果:**
- DrawTextは正しくY座標を処理（PDF座標系: 左下が原点）
- 抽出と描画で座標系は一致
- テストで検証済み

## 未解決の問題

### 1. ⚠️ 標準フォントの文字化け
**現象:**
```
正常: "billing@suno.com"
文字化け: "ó4 9 10 Ciel101", "Òl", "É è", "‰1810012", "ÅÄ"
```

**原因:**
- 元のPDFが複数の特殊フォント（F15, F18, F19など）を使用
- これらのフォントのエンコーディング情報またはToUnicode CMが正しく処理されていない
- 元のPDFの構造的な問題の可能性

**影響範囲:**
- 元のPDFからの抽出時のみ
- 新規作成PDFには影響なし

**対策:**
- より高度なフォントエンコーディング処理の実装が必要
- 現状では完全な修正は困難

### 2. ⚠️ 画像の異常座標
**現象:**
```
画像名: X7
CTM: [126.00 0.00 0.00 30.75 1900.00 -101221.88]
計算された位置: (1900.0, -101221.9)
```

**原因:**
- CTMのF値（Y変換）が-101221.88という異常値
- 元のPDFのコンテンツストリームの問題
- ページレベルの特殊な変換の可能性

**影響範囲:**
- 画像の配置位置が不正
- ページ外に配置される

**対策（main.go）:**
```go
// 異常な座標の画像はスキップまたは適当な位置に配置
if drawY < -1000 || drawY > pageHeight+1000 {
    // 例: ページ上部に配置
    drawY = pageHeight - placedHeight - 50
    drawX = 50
}
```

### 3. ⚠️ フォント情報の喪失
**現象:**
- 元のPDF: Helvetica, Helvetica-Bold, Times-Romanなど
- 再生成PDF: すべて日本語フォント（Koruri）

**影響:**
- 太字が失われる
- フォントの見た目が変わる
- 文字サイズが若干異なる場合がある

**対策（main.go）:**
標準フォントを適切に処理する:
```go
// TextElementのFont情報を確認
if strings.Contains(elem.Font, "Bold") {
    page.SetFont(gopdf.FontHelveticaBold, elem.Size)
} else {
    page.SetFont(gopdf.FontHelvetica, elem.Size)
}
```

## テスト結果

### 座標系テスト
```
✓ Y=700 → 上部に正しく配置
✓ Y=100 → 下部に正しく配置
✓ 抽出座標と描画座標が一致
```

### 日本語テスト
```
入力: "こんにちは世界"
抽出: "こんにちは世界"
✓ 正しく抽出できる
```

## 推奨される使用方法

### 1. シンプルなPDF
- 標準フォントのみ
- 回転・変換なし
- → 正常に再構成可能

### 2. 日本語PDF
- TTFフォント使用
- 画像なし
- → 正常に再構成可能

### 3. 複雑なPDF（元のPDFのような）
- 複数の特殊フォント
- 複雑なグラフィックス変換
- → 部分的な再構成のみ可能
- → 文字化けや画像配置の問題が残る

## 今後の改善方向

### Phase 1: フォント処理の改善
- 標準フォントの太字・イタリック対応
- ToUnicode CMのより正確な処理
- フォントエンコーディングの多様性対応

### Phase 2: グラフィックス変換の改善
- ページレベルのCTM処理
- UserSpace変換の考慮
- 特殊なグラフィックス状態の処理

### Phase 3: エラーハンドリング
- 異常値の自動検出と修正
- フォールバック処理
- 警告メッセージの充実

## 関連コミット
- 583dd4d: fix: Implement glyph-based ToUnicode CMap
- 57f1980: docs: Update tounicode_cmap_issue.md
