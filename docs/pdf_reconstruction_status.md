# PDF再構成の現状と課題

## 調査日
2025-10-29

## 実装済みの修正

### 1. ✅ 日本語テキスト抽出（完了）
**問題:** TTFフォントでのテキスト抽出が文字化けしていた
**修正:** グリフベースのToUnicode CMを実装
**コミット:** 583dd4d

### 2. ✅ Y座標系の動作（検証完了）
**確認結果:**
- DrawTextは正しくY座標を処理（PDF座標系: 左下が原点）
- 抽出と描画で座標系は一致
- テストで検証済み

## 未解決の問題

### 1. ⚠️ 標準フォントの文字化け（元のPDFの問題）
**現象:**
```
正常: "billing@suno.com"
文字化け: "ó4 9 10 Ciel101", "Òl", "É è", "‰1810012", "ÅÄ"
```

**詳細調査結果:**
```
元のPDFからの抽出:
- Block 3, Element 18: U+001B (制御文字) Font=F18
- Block 3, Element 19: 'ó' (U+00F3) Font=F19
- Block 3, Element 48: 'Ò' (U+00D2) Font=F16
- Block 3, Element 90: '‰' (U+2030) Font=F12
```

**根本原因:**
1. 元のPDFが複数の特殊フォント（F9-F19）を使用
2. これらのフォントに**ToUnicode CMが存在しない**か、正しく読み取れない
3. **元のPDFから抽出した時点で既に文字化けが発生**
4. 元のPDFの構造的な問題

**影響範囲:**
- 元のPDFからの抽出時に文字化け
- 再生成PDFにも文字化けが引き継がれる
- 新規作成PDFには影響なし

**実施した対策（main.go）:**
```go
// ASCIIテキスト: 標準フォント（Helvetica）で描画
// 非ASCIIテキスト: TTFフォントで描画
if isASCII {
    newPage.SetFont(gopdf.FontHelvetica, elem.Size)
} else {
    newPage.SetTTFFont(jpFont, elem.Size)
}
```

**結果:**
- ✅ 通常のASCIIテキストは正しく再生成される
- ❌ 元のPDFで既に文字化けしている部分は修正不可
- **制限:** 元のPDFに構造的な問題がある場合、完全な復元は困難

### 2. ⚠️ 画像の異常座標
**現象:**
```
画像名: X7
CTM: [126.00 0.00 0.00 30.75 1900.00 -101221.88]
計算された位置: (1900.0, -101221.9)
```

**原因:**
- CTMのF値（Y変換）が-101221.88という異常値
- 元のPDFのコンテンツストリームの問題
- ページレベルの特殊な変換の可能性

**影響範囲:**
- 画像の配置位置が不正
- ページ外に配置される

**対策（main.go）:**
```go
// 異常な座標の画像はスキップまたは適当な位置に配置
if drawY < -1000 || drawY > pageHeight+1000 {
    // 例: ページ上部に配置
    drawY = pageHeight - placedHeight - 50
    drawX = 50
}
```

### 3. ⚠️ フォント情報の喪失
**現象:**
- 元のPDF: Helvetica, Helvetica-Bold, Times-Romanなど
- 再生成PDF: すべて日本語フォント（Koruri）

**影響:**
- 太字が失われる
- フォントの見た目が変わる
- 文字サイズが若干異なる場合がある

**対策（main.go）:**
標準フォントを適切に処理する:
```go
// TextElementのFont情報を確認
if strings.Contains(elem.Font, "Bold") {
    page.SetFont(gopdf.FontHelveticaBold, elem.Size)
} else {
    page.SetFont(gopdf.FontHelvetica, elem.Size)
}
```

## テスト結果

### 座標系テスト
```
✓ Y=700 → 上部に正しく配置
✓ Y=100 → 下部に正しく配置
✓ 抽出座標と描画座標が一致
```

### 日本語テスト
```
入力: "こんにちは世界"
抽出: "こんにちは世界"
✓ 正しく抽出できる
```

## 推奨される使用方法

### 1. シンプルなPDF
- 標準フォントのみ
- 回転・変換なし
- → 正常に再構成可能

### 2. 日本語PDF
- TTFフォント使用
- 画像なし
- → 正常に再構成可能

### 3. 複雑なPDF（元のPDFのような）
- 複数の特殊フォント
- 複雑なグラフィックス変換
- → 部分的な再構成のみ可能
- → 文字化けや画像配置の問題が残る

## 今後の改善方向

### Phase 1: フォント処理の改善
- 標準フォントの太字・イタリック対応
- ToUnicode CMのより正確な処理
- フォントエンコーディングの多様性対応

### Phase 2: グラフィックス変換の改善
- ページレベルのCTM処理
- UserSpace変換の考慮
- 特殊なグラフィックス状態の処理

### Phase 3: エラーハンドリング
- 異常値の自動検出と修正
- フォールバック処理
- 警告メッセージの充実

## 関連コミット
- 583dd4d: fix: Implement glyph-based ToUnicode CMap
- 57f1980: docs: Update tounicode_cmap_issue.md
