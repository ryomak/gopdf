# CTM（Current Transformation Matrix）と座標変換の問題

## 問題の概要

Receipt-2021-3422.pdfでは、コンテンツストリームの最初に座標変換が適用されています：

```
.23999999 0 0 -.23999999 0 792 cm
```

この変換により：
- Y軸が反転（d = -0.24）
- 原点がページ上端に移動（f = 792）
- 0.24倍にスケール

## 現在の実装の問題

### テスト結果

修正前：
```
Text: "Page 1 of 1"
Position: Y=754.0  ← 実際は下部だが、座標は上部を示す
```

修正後（CTM適用）：
```
Text: "Page 1 of 1"
Position: Y=-2546.0  ← マイナスになってしまった
```

### 座標変換の理解

PDFでの座標変換の順序：
1. **ページレベルのCTM**（`cm`オペレータ）が最初に適用される
2. その変換後の座標空間で、**テキストマトリックス**（`Tm`）が適用される

つまり：
- 最終座標 = CTM(Tm(原点))

しかし、テキストマトリックスの`E`と`F`（位置成分）は、**既にCTMが適用された座標空間での値**です。

### 正しいアプローチ

テキストマトリックス `Tm` の位置成分（E, F）は、CTMが適用された後の座標空間にあります。

したがて：
1. **CTMを適用せずにテキストマトリックスから直接座標を取得するべき**
2. または、**Tmの座標を元の座標空間に戻す変換**（CTMの逆変換）が必要

## 解決策の検討

### 案1: CTMの逆変換を適用

現在のTm座標は変換後の空間にあるので、元の空間に戻す：
```go
// CTMの逆変換を計算
inverseCTM := e.graphicsState.CTM.Inverse()
// Tm座標を元の空間に戻す
x, y := inverseCTM.TransformPoint(e.textMatrix[4], e.textMatrix[5])
```

### 案2: Tm内のマトリックス成分だけを変換

Tmのマトリックス成分（A,B,C,D）は方向とスケールを表し、CTMと組み合わせる必要がありますが、
位置成分（E,F）は既に変換後の座標なので、そのまま使用：
```go
// Tm座標をそのまま使用（CTM適用後の空間）
x := e.textMatrix[4]
y := e.textMatrix[5]
```

### 案3: 画像抽出の実装を参考にする

`image_extractor.go`では、CTMを正しく処理しています。
同じアプローチを取るべきかもしれません。

## 次のステップ

1. 画像抽出のCTM処理を調査
2. テキスト抽出でも同じアプローチを適用
3. 変換後の座標がページ座標系（0-612 x 0-792）に収まることを確認
