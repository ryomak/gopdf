gopdf ライブラリ 要件定義書


1. 概要


1.1. プロジェクト名

gopdf

1.2. 目的

Go言語ネイティブ（Pure Go）で動作する、PDFの生成（書き込み）と解析（読み込み）を行うための、高機能かつパフォーマンスに優れたライブラリを開発する。CGOを使用した外部ライブラリ（C言語バインディング）への依存を排除し、Goの標準機能とエコシステムのみで完結させることを最大の特徴とする。

1.3. ターゲットと利用シーン

• ターゲット: Go言語でバックエンドシステムやCLIツールを開発するデベロッパー。
• 利用シーン:
    ◦ Webアプリケーションにおける帳票、請求書、レポートなどの動的PDF生成。
    ◦ 既存PDFドキュメントのデータ抽出（テキスト、画像、リンクの解析）。
    ◦ 既存PDFへの情報の追加（電子署名やカスタムデータの付与など ※ただし本要件のスコープ外の可能性あり）。
    ◦ PDFドキュメントの軽量な加工・編集。

2. システム要件


2.1. 開発言語

• Go (バージョン 1.18 以上を推奨。ジェネリクス等の利用を想定)

2.2. 依存関係

• Pure Go: CGOの使用を固く禁止する。OS固有のライブラリや外部Cライブラリへの依存は一切行わない。
• Goの標準ライブラリ、およびPure Goで実装されたサードパーティライブラリのみ利用可能とする。

3. 機能要件 (必須)


FR-1: PDF生成（書き込み）

PDFドキュメントをゼロから作成し、バイナリデータとして出力する機能。
• FR-1.1: ドキュメント生成: 新規にPDFドキュメントオブジェクトを作成できる。
• FR-1.2: ページ管理:
    ◦ ドキュメントに新しいページを追加できる。
    ◦ ページサイズ（A4, Letterなど）の標準指定、およびカスタムサイズ（幅、高さ）での指定ができる。
    ◦ ページの向き（縦、横）を指定できる。
• FR-1.3: テキスト描画:
    ◦ 指定したフォント、フォントサイズ、色で、ページ上の指定した座標（$x, y$）にテキストを描画できる。
    ◦ テキストの回転、傾斜（スキュー）などの基本的な変形をサポートする。
• FR-1.4: 画像描画:
    ◦ サポートする画像形式（JPEG, PNGを必須とする）を読み込み、ページ上の指定した座標およびサイズで描画できる。
    ◦ 画像の拡大・縮小、回転をサポートする。
• FR-1.5: 図形描画:
    ◦ 基本的な図形（線、矩形、円、ベジェ曲線など）を描画できる。
    ◦ 線の太さ、色、塗りつぶしの色を指定できる。
• FR-1.6: 出力:
    ◦ 生成したPDFドキュメントを、PDF仕様に準拠したバイナリデータとして出力できる。
    ◦ io.Writer インターフェース（ファイル、HTTPレスポンス、メモリバッファなど）への書き出しをサポートする。

FR-2: PDF解析（読み込み）

既存のPDFバイナリデータを読み込み、その内部構造とコンテンツを解析する機能。
• FR-2.1: ドキュメント読み込み:
    ◦ PDFファイルまたは io.Reader からバイナリデータを読み込み、PDFの内部構造（オブジェクト、クロスリファレンステーブルなど）を解析できる。
    ◦ 暗号化されたPDF（パスワード保護）の基本的なデコード（パスワード指定による復号）を試みること（※高度な暗号化は将来的な課題としても可）。
• FR-2.2: ページ情報取得:
    ◦ ドキュメントの総ページ数を取得できる。
    ◦ 各ページのサイズ（幅、高さ）を取得できる。
• FR-2.3: コンテンツ抽出 (テキスト):
    ◦ 指定したページのテキスト要素を抽出し、その内容、フォント情報、および配置された座標（$x, y$）とバウンディングボックス（サイズ）を取得できる。
• FR-2.4: コンテンツ抽出 (画像):
    ◦ 指定したページに埋め込まれている画像データを抽出し、その生データ（またはデコード後のデータ）、および配置された座標とサイズを取得できる。
• FR-2.5: コンテンツ抽出 (リンク):
    ◦ 指定したページに含まれるハイパーリンク（外部リンクURL、内部ページジャンプ）を抽出し、そのリンク先情報とクリック可能な領域（座標、サイズ）を取得できる。

FR-3: フォントサポート

テキスト描画に使用するフォントを管理する機能。
• FR-3.1: 標準フォント:
    ◦ PDF仕様で定義されている標準のType 1フォント（例: Helvetica, Times-Roman, Courier など）を、フォントデータを埋め込むことなく使用できる。
• FR-3.2: 外部フォント (TTF):
    ◦ 外部のTrueType (TTF) ファイルを読み込み、解析できる。
    ◦ TTFフォントをPDFに埋め込んで（サブセット埋め込み、またはフル埋め込み）使用できる。これにより、標準フォント以外の日本語フォントなども描画可能とする。

FR-4: メタデータとカスタムデータ

PDFの補助情報を操作する機能。
• FR-4.1: 標準メタデータ:
    ◦ PDFのInfo辞書に含まれる標準的なメタデータ（作成者、タイトル、サブジェクト、キーワードなど）の読み取りと設定（書き込み）ができる。
• FR-4.2: 隠しデータ（カスタムデータ）:
    ◦ PDFの仕様（例: カスタムプロパティ、非表示オブジェクト、プライベートデータなど）を利用し、アプリケーション固有のデータ（例: 内部ID、JSONデータなど）を、通常のビューワーでは表示されない形で埋め込むことができる。
    ◦ 埋め込んだ隠しデータを後から解析・読み取りできる。

FR-5: 既存PDFの変更（追記）

（要件「サイズしてもできる」の解釈に基づく）
既存のPDFを読み込み、内容を追加・変更する機能。
• FR-5.1: ページ追加: 既存のPDFに新しいページを追加できる。
• FR-5.2: コンテンツ追加: 既存のPDFの特定のページに対し、新しいコンテンツ（テキスト、画像など）を上書き描画（オーバーレイ）できる。
• （注: 既存コンテンツの完全な削除や置換は、PDFの構造上非常に複雑であるため、初期スコープでは「追記」を優先する。）

FR-6: ページ翻訳機能

既存PDFのレイアウトを維持したまま、コンテンツを翻訳した新しいPDFを生成する機能。
• FR-6.1: レイアウト解析:
    ◦ 既存PDFページからテキストブロック、画像、および各要素の座標とサイズ（バウンディングボックス）を抽出できる。
    ◦ テキストブロックごとのフォント情報（フォント名、サイズ、色）を取得できる。
• FR-6.2: 画像のサイズ保持:
    ◦ 既存PDFから画像を抽出し、元の画像の幅と高さの情報を正確に取得できる。
    ◦ 翻訳後のPDFに画像を配置する際、元のサイズと位置を保持して貼り付けることができる。
• FR-6.3: テキストボックス内での可変フォントサイズ:
    ◦ 指定された矩形領域（横幅、縦幅）内に、テキストを自動的にフィッティングさせる機能を提供する。
    ◦ テキストが矩形領域に収まるよう、フォントサイズを自動的に調整（縮小）できる。
    ◦ テキストの複数行表示にも対応し、適切な行間隔で自動改行を行う。
• FR-6.4: レイアウト保持型翻訳:
    ◦ 元のPDFのページサイズ、余白、各要素の配置を維持したまま、テキスト部分を翻訳後のテキストで置き換えた新しいPDFを生成できる。
    ◦ 画像やグラフィック要素は元の位置とサイズを保持する。
• FR-6.5: 多言語対応:
    ◦ 英語から日本語への翻訳を主なユースケースとするが、他の言語ペアにも対応できる設計とする。
    ◦ 日本語などのマルチバイト文字を正しく描画できるよう、TTFフォントの埋め込みをサポートする。

FR-7: Markdown変換機能

Markdownファイルを入力として、PDFドキュメントやプレゼンテーションスライドを生成する機能。
• FR-7.1: Markdown解析:
    ◦ CommonMark仕様に準拠したMarkdownファイルを解析できる。
    ◦ 見出し、段落、リスト（箇条書き、番号付き）、コードブロック、引用、テーブル、画像、リンクなどの基本要素を認識できる。
    ◦ GitHub Flavored Markdown (GFM) の拡張構文（テーブル、タスクリスト、取り消し線など）にも対応する。
• FR-7.2: Markdown to PDF変換:
    ◦ Markdownファイルを読み込み、適切なレイアウトでPDFドキュメントとして出力できる。
    ◦ 見出しレベルに応じたフォントサイズとスタイル（太字、斜体など）を自動適用する。
    ◦ コードブロックは等幅フォントで表示し、シンタックスハイライトに対応する（オプション）。
    ◦ 画像参照を解決し、適切なサイズで埋め込む。
    ◦ リンクはPDF内のアノテーションとして保持する。
• FR-7.3: Markdown to Slide変換:
    ◦ Markdownファイルを読み込み、プレゼンテーションスライド形式のPDFとして出力できる。
    ◦ 水平線（`---`）やレベル1見出し（`# `）をスライドの区切りとして解釈する。
    ◦ 各スライドは16:9または4:3のアスペクト比で生成できる。
    ◦ スライドタイトル、本文、箇条書き、コードブロック、画像を適切に配置する。
    ◦ シンプルなテーマ（配色、フォント、レイアウト）をサポートする。
• FR-7.4: スタイルカスタマイズ:
    ◦ CSS風の設定ファイルまたはGoの構造体でスタイル（フォント、色、余白、行間など）をカスタマイズできる。
    ◦ テンプレートベースのレイアウト設定をサポートする。
• FR-7.5: メタデータ対応:
    ◦ Markdownファイルのフロントマター（YAML、TOML形式）からタイトル、著者、日付などのメタデータを読み取り、PDF Infoに反映できる。

4. 非機能要件


NFR-1: パフォーマンス

• NFR-1.1: 効率的な処理: 大量のページや高解像度画像を含むPDFの生成・解析においても、過度なメモリ消費（メモリリークの防止）やCPU時間を消費しないよう、効率的なアルゴリズムとデータ構造を採用する。
• NFR-1.2: ストリーミング処理: 可能な限りストリーミングベースの処理（io.Reader/io.Writer の活用）をサポートし、巨大なファイルを一度にメモリにロードすることを回避する。

NFR-2: 並行処理（非同期実行）

• NFR-2.1: ゴルーチンセーフ: ライブラリのAPIは、並行実行（複数のゴルーチンからの同時アクセス）に対して安全であること。特に、単一のドキュメントオブジェクトに対する操作がスレッドセーフ（ミューテックス等による保護）であるか、または安全な非同期操作パターンを提供する。
• NFR-2.2: 並列処理: 複数の異なるPDFドキュメントの生成や解析処理を、並行（並列）して安全に実行できること。

NFR-3: API設計

• NFR-3.1: Goのイディオム: Go言語の標準的なイディオム（エラーハンドリング、インターフェースの活用など）に従った、シンプルで直感的、かつ型安全なAPIを提供する。
• NFR-3.2: 拡張性: 将来的に新しいPDF機能（フォーム、アノテーション、暗号化強化など）を追加しやすいよう、モジュール化された設計を心がける。

NFR-4: ドキュメンテーション

• NFR-4.1: APIリファレンス: go doc で参照可能な、公開APIに関する十分なドキュメントコメントを整備する。
• NFR-4.2: サンプルコード: 主要なユースケース（新規作成、TTFフォント利用、画像挿入、テキスト解析など）を網羅した、実行可能なサンプルコードを提供する。
